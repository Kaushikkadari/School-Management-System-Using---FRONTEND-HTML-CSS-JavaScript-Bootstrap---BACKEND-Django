{% extends 'accounts/base_teacher.html' %}
{% load static %}

{% block title_content %}My Students{% endblock %}

{% block main_content %}
<!-- <div style="display: flex; justify-content: flex-end; align-items: flex-start; position: relative;">
    <img src="{% static 'accounts/images/ST_logo1.png' %}" alt="SARAT TECH Logo" style="width: 180px; height: auto; margin-top: 10px; margin-right: 10px;">
</div> -->
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3">My Students</h1>
        <div class="btn-group">
            <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#exportModal">
                <i class="fas fa-file-export"></i> Export
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4">
        <div class="card-body">
            <form class="row g-3">
                <div class="col-md-3">
                    <label for="courseFilter" class="form-label">Course</label>
                    <select class="form-select" id="courseFilter">
                        <option value="">All Courses</option>
                        {% for course in courses %}
                        <option value="{{ course.id }}">{{ course.title }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="classFilter" class="form-label">Class</label>
                    <select class="form-select" id="classFilter">
                        <option value="">All Classes</option>
                        {% for class in classes %}
                        <option value="{{ class.id }}">{{ class.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="searchInput" class="form-label">Search</label>
                    <input type="text" class="form-control" id="searchInput" placeholder="Search students...">
                </div>
                <div class="col-md-2 d-flex align-items-end">
                    <button type="button" class="btn btn-secondary w-100" id="resetFilters">
                        <i class="fas fa-sync-alt"></i> Reset
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Students List -->
    <div class="row">
        {% if students %}
            {% for student in students %}
            <div class="col-md-6 col-lg-4 mb-4" data-course="{% for c in student.enrolled_courses.all %}{{ c.id }}{% if not forloop.last %},{% endif %}{% endfor %}" data-class="{{ student.class_section.id }}">
                <div class="card h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="flex-shrink-0">
                                {% if student.photo %}
                                <img src="{{ student.photo.url }}" alt="{{ student.get_full_name }}" class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">
                                {% else %}
                                <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                    <i class="fas fa-user"></i>
                                </div>
                                {% endif %}
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h5 class="card-title mb-0">{{ student.get_full_name }}</h5>
                                <small class="text-muted">ID: {{ student.student_id }}</small>
                                <br>
                                <small class="text-muted"><i class="fas fa-users"></i> {{ student.class_section.full_name }}</small>
                                <br>
                                <span class="badge bg-{% if student.status == 'active' %}success{% else %}secondary{% endif %}">
                                  {{ student.get_status_display }}
                                </span>
                                {% if student.last_updated %}<br><small class="text-muted">Last updated: {{ student.last_updated|date:"M d, Y H:i" }}</small>{% endif %}
                            </div>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="fas fa-envelope"></i> {{ student.user.email }}
                            </small>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="fas fa-phone"></i> {{ student.phone_number }}
                            </small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <small class="text-muted">Attendance:</small><br>
                                <span class="badge bg-{% if student.attendance_percentage >= 75 %}success{% elif student.attendance_percentage >= 50 %}warning{% else %}danger{% endif %}">
                                    {{ student.attendance_percentage|floatformat:1 }}%
                                </span>
                            </div>
                            <div class="text-end">
                                <small class="text-muted">Performance:</small><br>
                                <span class="badge bg-{% if student.performance >= 75 %}success{% elif student.performance >= 50 %}warning{% else %}danger{% endif %}">
                                    {{ student.performance|floatformat:1 }}%
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'teacher_student_detail' student.id %}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye"></i> View Details
                            </a>
                            <a href="{% url 'teacher_student_attendance' student.id %}" class="btn btn-sm btn-outline-info">
                                <i class="fas fa-calendar-check"></i> Attendance
                            </a>
                            <a href="{% url 'teacher_student_grades' student.id %}" class="btn btn-sm btn-outline-success">
                                <i class="fas fa-chart-line"></i> Grades
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
        <div class="col-12">
            <div class="text-center py-5">
                <img src="{% static 'img/no-students.svg' %}" alt="No Students" style="width: 200px; margin-bottom: 20px;">
                <h3>No Students Found</h3>
                <p class="text-muted">No students are currently enrolled in your courses.</p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Export Modal -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Export Students Data</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="exportForm" method="POST" action="{% url 'teacher_export_students' %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="exportFormat" class="form-label">Format</label>
                        <select class="form-select" id="exportFormat" name="format" required>
                            <option value="csv">CSV</option>
                            <option value="excel">Excel</option>
                            <option value="pdf">PDF</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="exportFields" class="form-label">Fields to Export</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="fields" value="basic_info" id="basicInfo" checked>
                            <label class="form-check-label" for="basicInfo">Basic Information</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="fields" value="attendance" id="attendance" checked>
                            <label class="form-check-label" for="attendance">Attendance Records</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="fields" value="grades" id="grades" checked>
                            <label class="form-check-label" for="grades">Grades</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="exportForm" class="btn btn-primary">Export</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize filters
        const courseFilter = document.getElementById('courseFilter');
        const classFilter = document.getElementById('classFilter');
        const searchInput = document.getElementById('searchInput');
        const resetButton = document.getElementById('resetFilters');
        
        // Filter functionality
        function filterStudents() {
            const course = courseFilter.value;
            const class_ = classFilter.value;
            const search = searchInput.value.toLowerCase();
            
            document.querySelectorAll('.col-md-6.col-lg-4').forEach(card => {
                let show = true;
                
                // Course filtering - Split the data-course attribute by comma and check if the selected course is in the list
                if (course) {
                    const courseIds = card.dataset.course.split(',');
                    if (!courseIds.includes(course)) {
                        show = false;
                    }
                }
                
                // Class filtering
                if (class_ && card.dataset.class !== class_) {
                    show = false;
                }
                
                // Search filtering
                if (search && !card.textContent.toLowerCase().includes(search)) {
                    show = false;
                }
                
                card.style.display = show ? '' : 'none';
            });
        }
        
        // Event listeners
        courseFilter.addEventListener('change', filterStudents);
        classFilter.addEventListener('change', filterStudents);
        searchInput.addEventListener('input', filterStudents);
        resetButton.addEventListener('click', function() {
            courseFilter.value = '';
            classFilter.value = '';
            searchInput.value = '';
            filterStudents();
        });
    });
</script>
{% endblock %} 